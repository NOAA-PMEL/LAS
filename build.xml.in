<project name="SATCHMO" default="dist" basedir=".">

	<property environment="env" />
	<property name="app.name" value="@APPNAME@" />
	<property name="jakarta.home" value="@JAKARTA_HOME@" />
	<property name="jakarta.lib" value="@JAKARTA_LIB@" />
	<property name="deploy.home"
		value="${jakarta.home}/webapps/${app.name}" />
	<property name="dist.war"
		value="${jakarta.home}/webapps/${app.name}.war" />
	<property name="build.compiler.emacs" value="true" />
	<target name="revision">
		<exec executable="./bin/revision.sh"
			failifexecutionfails="false" />
	</target>

	<target name="prepare" depends="revision">
		<mkdir dir="WebContent/WEB-INF/classes" />
		<mkdir dir="WebContent/docs" />
		<copy todir="WebContent/WEB-INF/classes">
			<fileset dir="JavaSource">
				<include name="resources/**" />
				<include name="**.properties" />
			</fileset>
		</copy>
		<copy file="WebContent/luis/web/levitus_monthly.html"
			tofile="WebContent/docs" />
		<mkdir dir="conf/server/custom/las_servlet/src" />
		<mkdir dir="conf/server/custom/las_servlet/web/images" />
		<mkdir dir="conf/server/custom/las_servlet/web" />
		<mkdir dir="conf/server/custom/las_servlet/web/images" />
	</target>
	<target name="iosp" depends="compile">
		<mkdir dir="dist/lib" />
		<jar jarfile="dist/lib/ferret_iosp.jar"
			basedir="WebContent/WEB-INF/classes"
			includes="gov/noaa/pmel/tmap/iosp/**, gov/noaa/pmel/tmap/ftds/**, resources/iosp/FerretConfig.xml, resources/iosp/**"
			excludes="dods**, thredds**, ucar**" />
	</target>

	<target name="javadoc-all">
		<delete dir="WebContent/docs" />
		<javadoc access="public" author="true" destdir="WebContent/docs"
			doctitle="The Java Live Access Server" nodeprecated="false"
			nodeprecatedlist="false" noindex="false" nonavbar="false"
			notree="false" overview="overview.html"
			packagenames="gov.noaa.pmel.tmap.iosp,gov.noaa.pmel.tmap.las.jdom,gov.noaa.pmel.tmap.ferret.server.dodstype,org.iges.anagram.service,gov.noaa.pmel.tmap.las.product.request,gov.noaa.pmel.tmap.las.service.java,gov.noaa.pmel.tmap.las.service.ferret,gov.noaa.pmel.tmap.las.luis.map,gov.noaa.pmel.tmap.ferret.server.importer,gov.noaa.pmel.tmap.ferret.server.dodsservice,org.iges.anagram.filter,gov.noaa.pmel.tmap.las.filter,gov.noaa.pmel.tmap.las.luis.db,org.iges.util,gov.noaa.pmel.tmap.las.luis,gov.noaa.pmel.tmap.las.product.server,gov.noaa.pmel.tmap.ferret.server,gov.noaa.pmel.tmap.las.service,gov.noaa.pmel.tmap.las.ui.state,gov.noaa.pmel.tmap.las.service.database,gov.noaa.pmel.tmap.las.service.drds,gov.noaa.pmel.tmap.las.ui,gov.noaa.pmel.tmap.las.util,org.iges.anagram"
			source="1.5" sourcepath="JavaSource" splitindex="true" use="true"
			version="true">
			<classpath>
				<pathelement path="classes" />
				<fileset dir="WebContent/WEB-INF/lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir="${jakarta.lib}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javadoc>
		<copy file="WebContent/luis/web/levitus_monthly.html"
			tofile="WebContent/docs/levitus_monthly.html" />
	</target>

	<target name="javadoc">
		<delete dir="WebContent/docs" />
		<javadoc access="public" author="true" destdir="WebContent/docs"
			doctitle="The Java Live Access Server" nodeprecated="false"
			nodeprecatedlist="false" noindex="false" nonavbar="false"
			notree="false" overview="overview.html"
			packagenames="gov.noaa.pmel.tmap.iosp,gov.noaa.pmel.tmap.las.jdom,gov.noaa.pmel.tmap.las.product.request,gov.noaa.pmel.tmap.las.service.java,gov.noaa.pmel.tmap.las.service.ferret,gov.noaa.pmel.tmap.las.filter,gov.noaa.pmel.tmap.las.product.server,gov.noaa.pmel.tmap.las.service,gov.noaa.pmel.tmap.las.service.database,gov.noaa.pmel.tmap.las.service.drds,gov.noaa.pmel.tmap.las.util"
			source="1.5" sourcepath="JavaSource" splitindex="true" use="true"
			version="true">
			<classpath>
				<pathelement path="classes" />
				<fileset dir="WebContent/WEB-INF/lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir="${jakarta.lib}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javadoc>
		<copy file="WebContent/luis/web/levitus_monthly.html"
			tofile="WebContent/docs/levitus_monthly.html" />
	</target>


	<target name="clean">
		<delete dir="WebContent/WEB-INF/classes/gov" />
		<delete dir="WebContent/WEB-INF/classes/au" />
		<delete dir="WebContent/WEB-INF/classes/dods" />
		<delete dir="WebContent/WEB-INF/classes/gnu" />
		<delete dir="WebContent/WEB-INF/classes/resources" />
		<delete file="${app.name}.war" />
	</target>


	<target name="compile" depends="prepare">
		<javac srcdir="JavaSource"
			includes="gov/**,au/**,org/**,dods/**,gnu/**"
			destdir="WebContent/WEB-INF/classes" debug="on" optimize="off"
			deprecation="off">
			<classpath>
				<pathelement path="classes" />
				<fileset dir="WebContent/WEB-INF/lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir="${jakarta.lib}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
	</target>

	<target name="dist" depends="prepare,compile">
		<war jarfile="${app.name}.war"
			webxml="WebContent/WEB-INF/web.xml">
			<classes dir="WebContent/WEB-INF/classes" includes="**" />
			<fileset dir="WebContent">
				<include name="examples/**" />
				<include name="TimeSeries/**" />
				<include name="VizGal/**" />
				<include name="classes/**" />
				<include name="productserver/**" />
				<include name="fds/**" />
				<include name="output/**" />
				<include name="images/**" />
				<include name="css/**" />
				<include name="html/**" />
				<include name="JavaScript/**" />
				<include name="docs/**" />
				<include name="doc/**" />
				<include name="WEB-INF/**" />
				<include name="**.html" />
				<include name="**.vm" />
				<include name="**.css" />
				<include name="**.htm" />
				<include name="**.js" />
				<include name="**.jsp" />
                                <exclude name="WEB-INF/lib/gwt-dev*.jar"/>
			</fileset>
			<fileset dir="WebContent/luis/velocity">
				<include name="**.vm" />
				<include name="**.html" />
				<include name="**.htm" />
				<include name="**.js" />
			</fileset>
			<fileset dir="WebContent/luis">
				<include name="images/**" />
			</fileset>
			<fileset dir="conf/server/custom/las_servlet/web">
				<include name="images/**" />
			</fileset>
			<fileset dir="conf/server/custom/las_servlet">
				<include name="web/**/*.ht*" />
			</fileset>
		</war>
	</target>

	<target name="deploy-iosp" depends="dist">
		<!-- Delete old IOSP code. -->
		<delete
			dir="${jakarta.home}/webapps/thredds/WEB-INF/classes/gov/noaa/pmel/tmap" />
		<delete
			dir="${jakarta.home}/webapps/thredds/WEB-INF/classes/resources/iosp" />
		<!-- Deploy new IOSP code. -->
		<copy todir="${jakarta.home}/webapps/thredds/WEB-INF/classes">
			<fileset dir="WebContent/WEB-INF/classes">
				<include name="gov/noaa/pmel/tmap/iosp/**" />
			</fileset>
			<fileset dir="JavaSource">
				<include name="resources/iosp/**" />
			</fileset>
		</copy>
		<copy file="JavaSource/resources/ferret/FerretBackendConfig.xml"
			tofile="${jakarta.home}/webapps/thredds/WEB-INF/classes/resources/iosp/FerretConfig.xml" />
	</target>
	<target name="deploy" depends="dist">
		<!-- Delete old IOSP code. -->
		<delete
			dir="${jakarta.home}/webapps/thredds/WEB-INF/classes/gov/noaa/pmel/tmap" />
		<delete
			dir="${jakarta.home}/webapps/thredds/WEB-INF/classes/resources/iosp" />
		<!-- Deploy new IOSP code. -->
		<copy todir="${jakarta.home}/webapps/thredds/WEB-INF/classes">
			<fileset dir="WebContent/WEB-INF/classes">
				<include name="gov/noaa/pmel/tmap/iosp/**" />
			</fileset>
			<fileset dir="JavaSource">
				<include name="resources/iosp/**" />
			</fileset>
		</copy>
		<copy file="JavaSource/resources/ferret/FerretBackendConfig.xml"
			tofile="${jakarta.home}/webapps/thredds/WEB-INF/classes/resources/iosp/FerretConfig.xml" />
		<delete dir="${deploy.home}" />
		<copy file="${app.name}.war" tofile="${dist.war}" />
	</target>

	<target name="velocity">
		<copy todir="${jakarta.home}/webapps/${app.name}">
			<fileset dir="WebContent/luis/velocity">
				<include name="**.vm" />
				<include name="**.html" />
				<include name="**.htm" />
				<include name="**.js" />
			</fileset>
		</copy>
	</target>
	<target name="selenium">
		<copy todir="${jakarta.home}/webapps/${app.name}/test">
			<fileset dir="test">
				<include name="**" />
			</fileset>
		</copy>
	</target>
	<target name="ui_images">
		<copy todir="${jakarta.home}/webapps/${app.name}/images">
			<fileset dir="WebContent/luis/images">
				<include name="**.jpg" />
				<include name="**.gif" />
			</fileset>
		</copy>
	</target>
	<target name="lps-lbes" depends="prepare,compile">
		<war jarfile="${app.name}.war"
			webxml="WebContent/WEB-INF/web.xml">
			<classes dir="WebContent/WEB-INF/classes" includes="**" />
			<fileset dir="WebContent">
				<include
					name="classes/gov/noaa/pmel/tmap/las/filter/**" />
				<include name="classes/gov/noaa/pmel/tmap/las/jdom/**" />
				<include
					name="classes/gov/noaa/pmel/tmap/las/product/**" />
				<include
					name="classes/gov/noaa/pmel/tmap/las/service/**" />
				<include name="productserver/**" />
				<include name="fds/**" />
				<include name="output/**" />
				<include name="images/**" />
				<include name="WEB-INF/**" />
				<include name="**.html" />
				<include name="**.htm" />
				<include name="**.js" />
				<include name="**.jsp" />
			</fileset>
		</war>
	</target>

	<target name="lps-lbes-deploy" depends="prepare,compile,lps-lbes">
		<delete dir="${ps-deploy.home}" />
		<copy file="${app.name}.war" tofile="${dist.war}" />
	</target>

	<target name="lps-lbes-clean">
		<delete dir="WebContent/classes/gov/noaa/pmel/tmap/las/filter" />
		<delete dir="WebContent/classes/gov/noaa/pmel/tmap/las/jdom" />
		<delete dir="WebContent/classes/gov/noaa/pmel/tmap/las/product" />
		<delete dir="WebContent/classes/gov/noaa/pmel/tmap/las/service" />
		<delete dir="WebContent/WEB-INF/classes/resources" />
		<delete file="${app.name}.war" />
	</target>
	<!-- Targets for addXML 

            ant addxml-compile  # will compile the code
            ant addxml-build    # depends on compile and will make a jar file in dist/lib/addXML.jar which is used by bin/addXML.sh
            ant addxml-dist     # creates a directory dist/addxml which is suitable to be tarred and distributed
            ant addxml          # used to build the distribution copy after ant-dist (everything is relative to /dist/addxml
            ant dist-clean      # cleans up the distribution directory

        -->
	<property name="addxml-src" value="JavaSource" />
	<property name="addxml-build" value="build" />
	<property name="addxml-dist" value="dist" />
	<target name="addxml-init">
		<tstamp />
		<mkdir dir="${addxml-build}" />
	</target>
	<target name="addxml-compile" depends="addxml-init">
		<copy file="${addxml-src}/gov/noaa/pmel/tmap/addxml/log4j.xml"
			tofile="${addxml-build}/log4j.xml" />
		<unjar src="WebContent/WEB-INF/lib/joda-time-1.5.2.jar"
			dest="${addxml-build}" />
		<unjar src="WebContent/WEB-INF/lib/JSAP_1.03a.jar"
			dest="${addxml-build}" />
		<unjar src="WebContent/WEB-INF/lib/toolsUI-4.0.jar"
			dest="${addxml-build}" />
		<unjar src="WebContent/WEB-INF/lib/log4j-1.2.13.jar"
			dest="${addxml-build}" />
		<javac
			srcdir="${addxml-src}/gov/noaa/pmel/tmap/addxml:${addxml-src}/org/joda"
			destdir="${addxml-build}">
			<classpath>
				<fileset id="addxml-libs"
					dir="WebContent/WEB-INF/lib">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
	</target>
	<target name="addxml-build" depends="addxml-compile">
		<mkdir dir="${addxml-dist}/lib" />
		<jar jarfile="${addxml-dist}/lib/addXML.jar"
			basedir="${addxml-build}" />
	</target>
	<target name="addxml-clean">
		<delete dir="${addxml-build}" />
	</target>
	<target name="addxml-dist">
		<mkdir dir="dist/addxml" />
		<mkdir dir="dist/addxml/src/gov/noaa/pmel/tmap/addxml" />
		<mkdir dir="dist/addxml/src/org/joda/time/chrono" />
		<mkdir dir="dist/addxml/bin" />
		<mkdir dir="dist/addxml/lib" />
		<copy todir="dist/addxml/src/gov/noaa/pmel/tmap/addxml">
			<fileset dir="JavaSource/gov/noaa/pmel/tmap/addxml">
				<include name="*.java" />
			</fileset>
		</copy>
		<copy todir="dist/addxml/src/org/joda/time/chrono">
			<fileset dir="JavaSource/org/joda/time/chrono">
				<include name="*.java" />
			</fileset>
		</copy>
		<copy file="JavaSource/gov/noaa/pmel/tmap/addxml/log4j.xml"
			tofile="dist/addxml/src/gov/noaa/pmel/tmap/addxml/log4j.xml" />
		<copy file="WebContent/WEB-INF/lib/joda-time-1.5.2.jar"
			todir="dist/addxml/lib" />
		<copy file="WebContent/WEB-INF/lib/JSAP_1.03a.jar"
			todir="dist/addxml/lib" />
		<copy file="WebContent/WEB-INF/lib/toolsUI-4.0.jar"
			todir="dist/addxml/lib" />
		<copy file="WebContent/WEB-INF/lib/log4j-1.2.13.jar"
			todir="dist/addxml/lib" />
		<copy file="bin/catalogClean.sh" todir="dist/addxml/bin" />
		<copy file="bin/addXML.sh.in"
			tofile="dist/addxml/bin/addXML.sh" />
		<chmod file="dist/addxml/bin/addXML.sh" perm="755" />
		<copy file="build.xml.in" tofile="dist/addxml/build.xml" />
		<copy file="bin/README_catalogCleaner.html"
			tofile="dist/addxml/README_catalogCleaner.html" />
		<copy file="bin/README" tofile="dist/addxml/README" />
	</target>
	<target name="addxml">
		<unjar src="lib/joda-time-1.5.2.jar" dest="${addxml-build}" />
		<unjar src="lib/JSAP_1.03a.jar" dest="${addxml-build}" />
		<unjar src="lib/toolsUI-4.0.jar" dest="${addxml-build}" />
		<unjar src="lib/log4j-1.2.13.jar" dest="${addxml-build}" />
		<javac srcdir="src/gov/noaa/pmel/tmap/addxml:src/org/joda"
			destdir="${addxml-build}">
			<classpath>
				<fileset id="addxml-libs" dir="lib">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
		<mkdir dir="${addxml-dist}/lib" />
		<copy file="src/gov/noaa/pmel/tmap/addxml/log4j.xml"
			todir="${addxml-dist}/lib" />
		<jar jarfile="${addxml-dist}/lib/addXML.jar"
			basedir="${addxml-build}" />
	</target>
	<target name="addxml-distclean">
		<delete dir="dist" />
	</target>

  <!-- Targets for creating a distribution of the map widget that can be used by other projects.  -->

  <target name="mapwidget-dist">
     <mkdir dir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/client/util" />
     <mkdir dir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/client/map" />
     <mkdir dir="dist/olmapwidget/bin" />
     <mkdir dir="dist/olmapwidget/lib" />
     <mkdir dir="dist/olmapwidget/war" />
     <mkdir dir="dist/olmapwidget/war/JavaScript/frameworks/OpenLayers" />
     <mkdir dir="dist/olmapwidget/war/JavaScript/components/css" />
     <mkdir dir="dist/olmapwidget/war/OLMapWidget" />
     <copy todir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/client/map">
        <fileset dir="JavaSource/gov/noaa/pmel/tmap/las/client/map">
           <include name="**/*.java"/>
        </fileset>
     </copy>
     <copy todir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/client/util">
        <fileset dir="JavaSource/gov/noaa/pmel/tmap/las/client/util">
           <include name="**/*.java"/>
           <exclude name="**/Util.java"/>
        </fileset>
     </copy>
     <copy todir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/client/openlayers">
        <fileset dir="JavaSource/gov/noaa/pmel/tmap/las/client/openlayers">
           <include name="**/*.java"/>
        </fileset>
     </copy>
     <copy todir="dist/olmapwidget/war/JavaScript/components/css">
        <fileset dir="WebContent/JavaScript/components/css">
           <include name="**/*.css"/>
           <include name="**/*.html"/>
        </fileset>
     </copy>
     <copy todir="dist/olmapwidget/war/JavaScript/components/images">
        <fileset dir="WebContent/JavaScript/components/images">
           <include name="**/*.*"/>
        </fileset>
     </copy>
     <copy todir="dist/olmapwidget/war/JavaScript/frameworks/OpenLayersExtensions">
        <fileset dir="WebContent/JavaScript/frameworks/OpenLayersExtensions">
           <include name="**/*.*"/>
        </fileset>
     </copy>
     <copy file="JavaSource/gov/noaa/pmel/tmap/las/NativeMapWidget.gwt.xml" todir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget"/>
     <copy file="WebContent/OLMapWidget/mapwidget.html" todir="dist/olmapwidget/war/OLMapWidget"/>
     <copy file="build.xml.in" tofile="dist/olmapwidget/build.xml"/>
     <copy file="bin/ol-compile.sh" todir="dist/olmapwidget/bin"/>
     <copy file="WebContent/WEB-INF/lib/gwtopenlayers.jar" todir="dist/olmapwidget/lib"/>
     <chmod file="dist/olmapwidget/bin/ol-compile.sh" perm="755" />
     <replaceregexp byline="true">
        <regexp pattern="gov.noaa.pmel.tmap.las.client"/>
        <substitution expression="com.weathertopconsulting.olmapwidget.client"/>
        <fileset dir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/">
           <include name="*.xml"/>
        </fileset>
        <fileset dir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/client/map">
           <include name="*.java"/>
        </fileset>
        <fileset dir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/client/util">
           <include name="*.java"/>
           <exclude name="Util.java"/>
        </fileset>
        <fileset dir="dist/olmapwidget/src/com/weathertopconsulting/olmapwidget/client/openlayers">
           <include name="*.java"/>
        </fileset>
     </replaceregexp>
  </target>
  <target name="mapwidget">
     <exec executable="./bin/ol-compile.sh" failifexecutionfails="false"/>
  </target>
  <target name="mapwidget-clean">
     <delete dir="dist/olmapwidget" />
  </target>
</project>
